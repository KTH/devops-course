name: Open Source Activity Check
on:
  pull_request:
    types:
      - labeled
    branches: [ 2021 ]

jobs:
  check-repo-activity-for-pr:
    if: github.event.label.name == 'contribution_to_opensource'
    runs-on: ubuntu-latest
    name: PR activity check
    steps:
      - name: Run action
        id: index
        uses: sfkwww/milkyway@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          text: ${{ github.event.pull_request.body }}
          min_stars: 10
          min_watchers: 10
          min_contributors: 10
          min_forks: 1
          min_commits: 100
          min_commits_last_year: 10
          min_open_issues: 10
      - name: Comment the results
        uses: actions/github-script@v3
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              [ ${{steps.index.outputs.repo}} ]
              -----------------------
              | Stat  |  Number |  Pass |
              |---|---|---|
              |Stars â­              | ${{fromJSON(steps.index.outputs.stars).count}}             | ${{ fromJSON('["âŒ", "âœ”ï¸"]')[fromJSON(steps.index.outputs.stars).pass] }}   |
              |Commits ğŸ“¦            | ${{fromJSON(steps.index.outputs.commits).count}}           | ${{ fromJSON('["âŒ", "âœ”ï¸"]')[fromJSON(steps.index.outputs.commits).pass] }} |
              |Commits Last Year â±ï¸  | ${{fromJSON(steps.index.outputs.commits_last_year).count}} | ${{ fromJSON('["âŒ", "âœ”ï¸"]')[fromJSON(steps.index.outputs.commits_last_year).pass] }} |
              |Watchers ğŸ‘€           | ${{fromJSON(steps.index.outputs.watchers).count}}          | ${{ fromJSON('["âŒ", "âœ”ï¸"]')[fromJSON(steps.index.outputs.watchers).pass] }} |
              |Contributors ğŸ§‘ğŸ»â€ğŸ¤â€ğŸ§‘ğŸ»       | ${{fromJSON(steps.index.outputs.contributors).count}}      | ${{ fromJSON('["âŒ", "âœ”ï¸"]')[fromJSON(steps.index.outputs.contributors).pass] }} |
              |Forks ğŸ´               | ${{fromJSON(steps.index.outputs.forks).count}}             | ${{ fromJSON('["âŒ", "âœ”ï¸"]')[fromJSON(steps.index.outputs.forks).pass] }} |
              |Open Issues ğŸŸ¢        | ${{fromJSON(steps.index.outputs.open_issues).count}}       | ${{ fromJSON('["âŒ", "âœ”ï¸"]')[fromJSON(steps.index.outputs.open_issues).pass] }} |
              `
            })
            if (!${{steps.index.outputs.final_pass}}) {
              core.setFailed('The repository did not meet the minimum requirements')
            }
